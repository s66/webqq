<!DOCTYPE HTML><html><head><meta charset="utf-8" /> <title>AppMarket2.0</title><link href="css/appmarket.css" rel="stylesheet"/><link href="css/widget/pages.css" rel="stylesheet"/><script src="js/1k.js"></script><script src="js/widget/pages.js"></script><script>$1k(function(Z){    var    appmarket = parent.WEBJJ.appmarket,    //从主页面下读取接口    Calls = appmarket.Calls,    Desktop = appmarket.Desktop,    App = appmarket.App,    Data = appmarket.Data,    loadAppData = Data.loadApp,    getApp = Data.getApp,        cache = {},    LIST_SIZE = 6, //每页显示app数量    DATA_SIZE = 96, //每页JSON数据的大小    PAGE_SIZE = 9, //分页大小    pagination,    category, //分类    current, //当前页    listElem, //列表容器    focusCatNav,    end;    Calls('market')        .wait([            //一些初始化            function(){ ///init                            listElem = Z('#appDetailList');                 pagination = Z.Pages(Z.query('#pagination'), 0, PAGE_SIZE)                    .change(function(index){                        getPage(category, index, function(){                                                    });                    });                this.ready();            },                        //载入第一页数据            function(){ ///loadFirstPage                focusCatNav = Z('.catNavTrigger').eq(1).cls('+select');                getPage(-1, 1, this.ready);            },                        //绑定导航事件            function(){ ///setNav                                Z('#cat_nav').click(function(evt){                    var cat = Z(evt.target).attr('cat');                    if(cat){                        focusCatNav.cls('-select');                        focusCatNav = Z(evt.target).cls('+select');                        getPage(cat, current);                      }                                    });                this.ready();            },                        //绑定添加应用的事件            function(){ ///setAddEvent                listElem.click(function(evt){                    evt.preventDefault();                    if(evt.target.className == 'appAddBtn'){                        var                        li = Z(evt.target).parent('li'),                        appid = li.attr('appid'),                        appver = li.attr('ver');                                                Data.saveApp(appid, appver, function(success){                            if(success){                                evt.target.className = 'appAddedText';                                Desktop.currentDesk().addApp(new App(appid), -1);                            }                        });                                                                     }                                });                this.ready();            },                    ])       .done(function(){            Z('body').show();       });        function getPage(cate, index, ready){        if(cate == category && index == current){            return;        }        if(cate != category ){            category = cate;            index = 1;         }        current = index;                var        dataIndex = Math.ceil(current * LIST_SIZE / DATA_SIZE), //当前数据在JSON中的索引        url = 'apps/list/'+[category, dataIndex].join('_')+'.json',        listHtml = [],        cbs = Calls('loadPage')            //获取列表数据            .wait(function(ready){ ///getListData                if(cache[url]){                    ready();                }else{                    Z.get(url+'?'+ +new Date, function(result){                        cache[url] = result;                        ready();                    });                }            })                        .wait(function(){ ///jsondata                                var                 data = cache[url],                dataStart = ((current - 1) * LIST_SIZE) % DATA_SIZE, //数据与当前数据页的偏移量                dataEnd = dataStart + LIST_SIZE,                apps = data.apps.slice(dataStart, dataEnd), //从data中截取对应的数据                getDetailDataFns = [];                                                Z.each(apps, function(app){ //listData                    getDetailDataFns.push(function(ready){ ///loadAppData                        var self = this;                        loadAppData(app.id, app.ver, function(app){ //detailData                            listHtml.push(dataToHtml(app));                            ready();                        });                      });                                    });                                //在等待数据的时候对分页进行渲染                getDetailDataFns.push(function(ready){ ///renderPages                    pagination.setTotal(0|(data.count / LIST_SIZE)).render();                    ready();                });                                //数据就绪，开始加载详情数据                Calls('jsondata')                    .wait(getDetailDataFns)                    .done(this.ready);                            })                        //所有数据都就绪，开始渲染            .add(function(){ ///renderList                listElem.html(listHtml);            })            .done(ready);    }        //数据转html    function dataToHtml(app){ ///dataToHtml        return '<li class="appListLi" appid="'+app.id+'" ver="'+app.ver+'">\        <div class="column1">'+appIcon(app.id)+'<div class="appAuth" title=" "></div></div>\        <div class="column2">\        <div class="appName"><span title="'+app.name+'">'+app.name+'</aspan></div>\        <div class="appBrief" title="'+Z.encodeHTML(app.brief)+'">'+Z.encodeHTML(app.brief)+'</div>\        </div>\        <div class="column3">\        <div class="appStars" title="4.14分"><div class="appStar" style="width: 82.8%"></div></div><div class="appAddedCount" title="人气：6570748">6570748</div>\        </div>\        <div class="column4"><a class="'+(App.hasAdd(app.id) ? 'appAddedText' : 'appAddBtn')+'" href="#" hidefocus="">已添加</a></div>\        </li>';    }        function appIcon(appid){        //return '<div class="appIcon"><img width="48" height="48" src="http://www.1kjs.com/web++.dev/apps/icon/default.png"></div>';        return '<div class="appIcon"><img width="48" height="48" src="http://0.web.qstatic.com/webqqpic/pubapps/'+(~~(appid/1000))+'/'+appid+'/images/big.png"></div>';    }    });</script></head><body><div id="container">    <div id="cat_nav" class="cat_nav">		<div class="catNavTrigger" cmd="main" cat="-2" style="display:none"><span class="cat_icon cat_2"></span>推荐应用</div>		<div class="catNavTrigger" cmd="all" cat="-1"><span class="cat_icon cat_1"></span>全部应用</div>		<div class="catNavTrigger" cmd="all" cat="0"><span class="cat_icon cat0"></span>娱乐</div>		<div class="catNavTrigger" cmd="all" cat="1"><span class="cat_icon cat1"></span>游戏</div>		<div class="catNavTrigger" cmd="all" cat="2"><span class="cat_icon cat2"></span>生活</div>		<div class="catNavTrigger" cmd="all" cat="3"><span class="cat_icon cat3"></span>音乐</div>		<div class="catNavTrigger" cmd="all" cat="4"><span class="cat_icon cat4"></span>新闻</div>		<div class="catNavTrigger" cmd="all" cat="5"><span class="cat_icon cat5"></span>工具</div>		<div class="catNavTrigger" cmd="all" cat="6"><span class="cat_icon cat6"></span>读书</div>		<div class="catNavTrigger" cmd="all" cat="7"><span class="cat_icon cat7"></span>社交</div>		<div class="catNavTrigger" cmd="all" cat="8"><span class="cat_icon cat8"></span>办公</div>		<div class="catNavTrigger" cmd="all" cat="11"><span class="cat_icon cat11"></span>儿童</div>		<div class="catNavTrigger" cmd="all" cat="12"><span class="cat_icon cat12"></span>网站</div>		<div class="catNavTrigger" cmd="all" cat="10"><span class="cat_icon cat10"></span>Widgets</div>	</div>    <div class="cat_nav_button cat_nav_up" id="cat_nav_up" style="display:none;"></div>	<div class="cat_nav_button cat_nav_down" id="cat_nav_down" style="display:none;"></div>    <div id="page_container" class="page_container">	    <div id="all" class="page">	        <div id="all_region_l" class="region region_l">                                <div class="appSheetContainer" id="appPanel_all_list_body"> <ul id="appDetailList" class="appListUl appDetailList">                     </ul> </div>                                              <div id="pagination" class="pagination"></div>            </div>	        <div id="all_region_rt" class="region region_rt"></div>	        <div id="all_region_rb" class="region region_rb"></div>	    </div>        	</div>        </div></body></html>